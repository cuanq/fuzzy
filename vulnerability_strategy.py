"""
File: test.py
Authors: Zack Downs <zjd2035@gmail.com>, Danielle Gonzalez <dng2551@rit.edu>, Stephan Wlodarczyk <stephanjwlodarczyk@gmail.com>
"""

import requests

class VulnerabilityStrategy:  

  def __init__(self, forms, vulnerability, options):

    self.forms = forms    
    self.vulnerability = vulnerability 
    self.options = options

  def run(self):
    """
    execute strategy.
    calls execute of the concrete strategy passed into this object's constructor
    """
    self.vulnerability.execute(self.forms,self.session,self)

  def _getVectors(self):
    """
    returns an array representation of all vectors 
    @private - should only be used internally by concrete strategies
    """
    vectors = None

    try:
      vectors = open(self.options.vectors, "r").read().splitlines()
    except IOError, (ErrorNumber, ErrorMessage):

      if ErrorNumber == 2: # File not found
        logger.error("Oh noes! Vector file not found!")
      else:
        logger.error("You managed successfully to trip a #%d error" % ErrorNumber)
        logger.error(ErrorMessage)

    return vectors

  def _executeVector(self, url, vector, form):
    """
    executes a vector for a given form and page and returns the response
    @url - the url 
    @vector - the vector to execute
    @form - the form to execute/fuzz the vector with.

    @private - should only be used internally by a concrete strategy
    """
    payload = {} # inputs to submit
    action = form.get('action')
    method = form.get('method')
    response = None 
    
    # fuzz all inputs in the form
    for input in form.get("inputs"):
      payload[input] = vector
    
    # supported actions are post/get
    try:
      if method == "post" or method == "POST":
          response = self.session.post(url + "/" + action, data = payload)

      elif method == "get" or method == "GET": 
          response = self.session.get(url + "/" + action, params = payload)

    except requests.exceptions.TooManyRedirects:
      pass
     # logger.error("too many redirect exception trying " + action + " on " + url)

    if response != None:
      response.cookies = self.session.cookies

    return response